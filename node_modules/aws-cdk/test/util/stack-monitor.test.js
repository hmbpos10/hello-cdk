"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mock_sdk_1 = require("./mock-sdk");
const stack_activity_monitor_1 = require("../../lib/api/util/cloudformation/stack-activity-monitor");
const util_1 = require("../util");
let sdk;
let printer;
beforeEach(() => {
    sdk = new mock_sdk_1.MockSdk();
    printer = new FakePrinter();
});
test('continue to the next page if it exists', async () => {
    await testMonitorWithEventCalls([
        (request) => {
            expect(request.NextToken).toBeUndefined();
            return {
                StackEvents: [event(102)],
                NextToken: 'some-token',
            };
        },
        (request) => {
            expect(request.NextToken).toBe('some-token');
            return {
                StackEvents: [event(101)],
            };
        },
    ]);
    // Printer sees them in chronological order
    expect(printer.eventIds).toEqual(['101', '102']);
});
test('do not page further if we already saw the last event', async () => {
    await testMonitorWithEventCalls([
        (request) => {
            expect(request.NextToken).toBeUndefined();
            return {
                StackEvents: [event(101)],
            };
        },
        (request) => {
            expect(request.NextToken).toBeUndefined();
            return {
                StackEvents: [event(102), event(101)],
                NextToken: 'some-token',
            };
        },
        (request) => {
            // Did not use the token
            expect(request.NextToken).toBeUndefined();
            return {};
        },
    ]);
    // Seen in chronological order
    expect(printer.eventIds).toEqual(['101', '102']);
});
test('do not page further if the last event is too old', async () => {
    await testMonitorWithEventCalls([
        (request) => {
            expect(request.NextToken).toBeUndefined();
            return {
                StackEvents: [event(101), event(95)],
                NextToken: 'some-token',
            };
        },
        (request) => {
            // Start again from the top
            expect(request.NextToken).toBeUndefined();
            return {};
        },
    ]);
    // Seen only the new one
    expect(printer.eventIds).toEqual(['101']);
});
test('do a final request after the monitor is stopped', async () => {
    await testMonitorWithEventCalls([
        // Before stop
        (request) => {
            expect(request.NextToken).toBeUndefined();
            return {
                StackEvents: [event(101)],
            };
        },
    ], 
    // After stop
    [
        (request) => {
            expect(request.NextToken).toBeUndefined();
            return {
                StackEvents: [event(102), event(101)],
            };
        },
    ]);
    // Seen both
    expect(printer.eventIds).toEqual(['101', '102']);
});
const T0 = 1597837230504;
// Events 0-99 are before we started paying attention
const T100 = T0 + 100 * 1000;
function event(nr) {
    return {
        EventId: `${nr}`,
        StackId: 'StackId',
        StackName: 'StackName',
        Timestamp: new Date(T0 + nr * 1000),
    };
}
async function testMonitorWithEventCalls(beforeStopInvocations, afterStopInvocations = []) {
    let describeStackEvents = jest.fn();
    let finished = false;
    for (const invocation of beforeStopInvocations) {
        const invocation_ = invocation; // Capture loop variable in local because of closure semantics
        const isLast = invocation === beforeStopInvocations[beforeStopInvocations.length - 1];
        describeStackEvents = describeStackEvents.mockImplementationOnce(request => {
            const ret = invocation_(request);
            if (isLast) {
                finished = true;
            }
            return ret;
        });
    }
    for (const invocation of afterStopInvocations) {
        describeStackEvents = describeStackEvents.mockImplementationOnce(invocation);
    }
    describeStackEvents.mockImplementation(() => { return {}; });
    sdk.stubCloudFormation({ describeStackEvents });
    const monitor = new stack_activity_monitor_1.StackActivityMonitor(sdk.cloudFormation(), 'StackName', printer, undefined, new Date(T100)).start();
    await waitForCondition(() => finished);
    await monitor.stop();
}
class FakePrinter {
    constructor() {
        this.updateSleep = 0;
        this.activities = [];
    }
    get eventIds() {
        return this.activities.map(a => a.event.EventId);
    }
    addActivity(activity) {
        this.activities.push(activity);
    }
    print() { }
    start() { }
    stop() { }
}
async function waitForCondition(cb) {
    while (!cb()) {
        await (0, util_1.sleep)(10);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stbW9uaXRvci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3RhY2stbW9uaXRvci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQXFDO0FBQ3JDLHFHQUFpSTtBQUNqSSxrQ0FBZ0M7QUFFaEMsSUFBSSxHQUFZLENBQUM7QUFDakIsSUFBSSxPQUFvQixDQUFDO0FBQ3pCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxHQUFHLEdBQUcsSUFBSSxrQkFBTyxFQUFFLENBQUM7SUFDcEIsT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDOUIsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsd0NBQXdDLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDeEQsTUFBTSx5QkFBeUIsQ0FBQztRQUM5QixDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1YsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUMxQyxPQUFPO2dCQUNMLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDekIsU0FBUyxFQUFFLFlBQVk7YUFDeEIsQ0FBQztRQUNKLENBQUM7UUFDRCxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1YsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDN0MsT0FBTztnQkFDTCxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDMUIsQ0FBQztRQUNKLENBQUM7S0FDRixDQUFDLENBQUM7SUFFSCwyQ0FBMkM7SUFDM0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNuRCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxzREFBc0QsRUFBRSxLQUFL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QztJQUU3RCxHQUFHLENBQUMsa0JBQWtCLENBQUMsRUFBRSxtQkFBbUIsRUFBRSxDQUFDLENBQUM7SUFFaEQsTUFBTSxPQUFPLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4SCxNQUFNLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZDLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3ZCLENBQUM7QUFHRCxNQUFNLFdBQVc7SUFBakI7UUFDUyxnQkFBVyxHQUFXLENBQUMsQ0FBQztRQUNmLGVBQVUsR0FBb0IsRUFBRSxDQUFDO0lBYW5ELENBQUM7SUFYQyxJQUFXLFFBQVE7UUFDakIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVNLFdBQVcsQ0FBQyxRQUF1QjtRQUN4QyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRU0sS0FBSyxLQUFXLENBQUM7SUFDakIsS0FBSyxLQUFXLENBQUM7SUFDakIsSUFBSSxLQUFXLENBQUM7Q0FDeEI7QUFFRCxLQUFLLFVBQVUsZ0JBQWdCLENBQUMsRUFBaUI7SUFDL0MsT0FBTyxDQUFDLEVBQUUsRUFBRSxFQUFFO1FBQ1osTUFBTSxJQUFBLFlBQUssRUFBQyxFQUFFLENBQUMsQ0FBQztLQUNqQjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2NrU2RrIH0gZnJvbSAnLi9tb2NrLXNkayc7XG5pbXBvcnQgeyBTdGFja0FjdGl2aXR5TW9uaXRvciwgSUFjdGl2aXR5UHJpbnRlciwgU3RhY2tBY3Rpdml0eSB9IGZyb20gJy4uLy4uL2xpYi9hcGkvdXRpbC9jbG91ZGZvcm1hdGlvbi9zdGFjay1hY3Rpdml0eS1tb25pdG9yJztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnLi4vdXRpbCc7XG5cbmxldCBzZGs6IE1vY2tTZGs7XG5sZXQgcHJpbnRlcjogRmFrZVByaW50ZXI7XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc2RrID0gbmV3IE1vY2tTZGsoKTtcbiAgcHJpbnRlciA9IG5ldyBGYWtlUHJpbnRlcigpO1xufSk7XG5cbnRlc3QoJ2NvbnRpbnVlIHRvIHRoZSBuZXh0IHBhZ2UgaWYgaXQgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICBhd2FpdCB0ZXN0TW9uaXRvcldpdGhFdmVudENhbGxzKFtcbiAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMildLFxuICAgICAgICBOZXh0VG9rZW46ICdzb21lLXRva2VuJyxcbiAgICAgIH07XG4gICAgfSxcbiAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlKCdzb21lLXRva2VuJyk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSldLFxuICAgICAgfTtcbiAgICB9LFxuICBdKTtcblxuICAvLyBQcmludGVyIHNlZXMgdGhlbSBpbiBjaHJvbm9sb2dpY2FsIG9yZGVyXG4gIGV4cGVjdChwcmludGVyLmV2ZW50SWRzKS50b0VxdWFsKFsnMTAxJywgJzEwMiddKTtcbn0pO1xuXG50ZXN0KCdkbyBub3QgcGFnZSBmdXJ0aGVyIGlmIHdlIGFscmVhZHkgc2F3IHRoZSBsYXN0IGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICBhd2FpdCB0ZXN0TW9uaXRvcldpdGhFdmVudENhbGxzKFtcbiAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSldLFxuICAgICAgfTtcbiAgICB9LFxuICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICBleHBlY3QocmVxdWVzdC5OZXh0VG9rZW4pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIFN0YWNrRXZlbnRzOiBbZXZlbnQoMTAyKSwgZXZlbnQoMTAxKV0sXG4gICAgICAgIE5leHRUb2tlbjogJ3NvbWUtdG9rZW4nLFxuICAgICAgfTtcbiAgICB9LFxuICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICAvLyBEaWQgbm90IHVzZSB0aGUgdG9rZW5cbiAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH0sXG4gIF0pO1xuXG4gIC8vIFNlZW4gaW4gY2hyb25vbG9naWNhbCBvcmRlclxuICBleHBlY3QocHJpbnRlci5ldmVudElkcykudG9FcXVhbChbJzEwMScsICcxMDInXSk7XG59KTtcblxudGVzdCgnZG8gbm90IHBhZ2UgZnVydGhlciBpZiB0aGUgbGFzdCBldmVudCBpcyB0b28gb2xkJywgYXN5bmMgKCkgPT4ge1xuICBhd2FpdCB0ZXN0TW9uaXRvcldpdGhFdmVudENhbGxzKFtcbiAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSksIGV2ZW50KDk1KV0sXG4gICAgICAgIE5leHRUb2tlbjogJ3NvbWUtdG9rZW4nLFxuICAgICAgfTtcbiAgICB9LFxuICAgIChyZXF1ZXN0KSA9PiB7XG4gICAgICAvLyBTdGFydCBhZ2FpbiBmcm9tIHRoZSB0b3BcbiAgICAgIGV4cGVjdChyZXF1ZXN0Lk5leHRUb2tlbikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH0sXG4gIF0pO1xuXG4gIC8vIFNlZW4gb25seSB0aGUgbmV3IG9uZVxuICBleHBlY3QocHJpbnRlci5ldmVudElkcykudG9FcXVhbChbJzEwMSddKTtcbn0pO1xuXG50ZXN0KCdkbyBhIGZpbmFsIHJlcXVlc3QgYWZ0ZXIgdGhlIG1vbml0b3IgaXMgc3RvcHBlZCcsIGFzeW5jICgpID0+IHtcbiAgYXdhaXQgdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhbXG4gICAgLy8gQmVmb3JlIHN0b3BcbiAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMSldLFxuICAgICAgfTtcbiAgICB9LFxuICBdLFxuICAvLyBBZnRlciBzdG9wXG4gIFtcbiAgICAocmVxdWVzdCkgPT4ge1xuICAgICAgZXhwZWN0KHJlcXVlc3QuTmV4dFRva2VuKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja0V2ZW50czogW2V2ZW50KDEwMiksIGV2ZW50KDEwMSldLFxuICAgICAgfTtcbiAgICB9LFxuICBdKTtcblxuICAvLyBTZWVuIGJvdGhcbiAgZXhwZWN0KHByaW50ZXIuZXZlbnRJZHMpLnRvRXF1YWwoWycxMDEnLCAnMTAyJ10pO1xufSk7XG5cbmNvbnN0IFQwID0gMTU5NzgzNzIzMDUwNDtcblxuLy8gRXZlbnRzIDAtOTkgYXJlIGJlZm9yZSB3ZSBzdGFydGVkIHBheWluZyBhdHRlbnRpb25cbmNvbnN0IFQxMDAgPSBUMCArIDEwMCAqIDEwMDA7XG5cbmZ1bmN0aW9uIGV2ZW50KG5yOiBudW1iZXIpOiBBV1MuQ2xvdWRGb3JtYXRpb24uU3RhY2tFdmVudCB7XG4gIHJldHVybiB7XG4gICAgRXZlbnRJZDogYCR7bnJ9YCxcbiAgICBTdGFja0lkOiAnU3RhY2tJZCcsXG4gICAgU3RhY2tOYW1lOiAnU3RhY2tOYW1lJyxcbiAgICBUaW1lc3RhbXA6IG5ldyBEYXRlKFQwICsgbnIgKiAxMDAwKSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdGVzdE1vbml0b3JXaXRoRXZlbnRDYWxscyhcbiAgYmVmb3JlU3RvcEludm9jYXRpb25zOiBBcnJheTwoeDogQVdTLkNsb3VkRm9ybWF0aW9uLkRlc2NyaWJlU3RhY2tFdmVudHNJbnB1dCkgPT4gQVdTLkNsb3VkRm9ybWF0aW9uLkRlc2NyaWJlU3RhY2tFdmVudHNPdXRwdXQ+LFxuICBhZnRlclN0b3BJbnZvY2F0aW9uczogQXJyYXk8KHg6IEFXUy5DbG91ZEZvcm1hdGlvbi5EZXNjcmliZVN0YWNrRXZlbnRzSW5wdXQpID0+IEFXUy5DbG91ZEZvcm1hdGlvbi5EZXNjcmliZVN0YWNrRXZlbnRzT3V0cHV0PiA9IFtdLFxuKSB7XG4gIGxldCBkZXNjcmliZVN0YWNrRXZlbnRzID0gKGplc3QuZm4oKSBhcyBqZXN0Lk1vY2s8QVdTLkNsb3VkRm9ybWF0aW9uLkRlc2NyaWJlU3RhY2tFdmVudHNPdXRwdXQsIFtBV1MuQ2xvdWRGb3JtYXRpb24uRGVzY3JpYmVTdGFja0V2ZW50c0lucHV0XT4pO1xuXG4gIGxldCBmaW5pc2hlZCA9IGZhbHNlO1xuXG4gIGZvciAoY29uc3QgaW52b2NhdGlvbiBvZiBiZWZvcmVTdG9wSW52b2NhdGlvbnMpIHtcbiAgICBjb25zdCBpbnZvY2F0aW9uXyA9IGludm9jYXRpb247IC8vIENhcHR1cmUgbG9vcCB2YXJpYWJsZSBpbiBsb2NhbCBiZWNhdXNlIG9mIGNsb3N1cmUgc2VtYW50aWNzXG4gICAgY29uc3QgaXNMYXN0ID0gaW52b2NhdGlvbiA9PT0gYmVmb3JlU3RvcEludm9jYXRpb25zW2JlZm9yZVN0b3BJbnZvY2F0aW9ucy5sZW5ndGggLSAxXTtcbiAgICBkZXNjcmliZVN0YWNrRXZlbnRzID0gZGVzY3JpYmVTdGFja0V2ZW50cy5tb2NrSW1wbGVtZW50YXRpb25PbmNlKHJlcXVlc3QgPT4ge1xuICAgICAgY29uc3QgcmV0ID0gaW52b2NhdGlvbl8ocmVxdWVzdCk7XG4gICAgICBpZiAoaXNMYXN0KSB7XG4gICAgICAgIGZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXQ7XG4gICAgfSk7XG4gIH1cbiAgZm9yIChjb25zdCBpbnZvY2F0aW9uIG9mIGFmdGVyU3RvcEludm9jYXRpb25zKSB7XG4gICAgZGVzY3JpYmVTdGFja0V2ZW50cyA9IGRlc2NyaWJlU3RhY2tFdmVudHMubW9ja0ltcGxlbWVudGF0aW9uT25jZShpbnZvY2F0aW9uKTtcbiAgfVxuICBkZXNjcmliZVN0YWNrRXZlbnRzLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7IHJldHVybiB7fTsgfSk7XG5cbiAgc2RrLnN0dWJDbG91ZEZvcm1hdGlvbih7IGRlc2NyaWJlU3RhY2tFdmVudHMgfSk7XG5cbiAgY29uc3QgbW9uaXRvciA9IG5ldyBTdGFja0FjdGl2aXR5TW9uaXRvcihzZGsuY2xvdWRGb3JtYXRpb24oKSwgJ1N0YWNrTmFtZScsIHByaW50ZXIsIHVuZGVmaW5lZCwgbmV3IERhdGUoVDEwMCkpLnN0YXJ0KCk7XG4gIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4gZmluaXNoZWQpO1xuICBhd2FpdCBtb25pdG9yLnN0b3AoKTtcbn1cblxuXG5jbGFzcyBGYWtlUHJpbnRlciBpbXBsZW1lbnRzIElBY3Rpdml0eVByaW50ZXIge1xuICBwdWJsaWMgdXBkYXRlU2xlZXA6IG51bWJlciA9IDA7XG4gIHB1YmxpYyByZWFkb25seSBhY3Rpdml0aWVzOiBTdGFja0FjdGl2aXR5W10gPSBbXTtcblxuICBwdWJsaWMgZ2V0IGV2ZW50SWRzKCkge1xuICAgIHJldHVybiB0aGlzLmFjdGl2aXRpZXMubWFwKGEgPT4gYS5ldmVudC5FdmVudElkKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRBY3Rpdml0eShhY3Rpdml0eTogU3RhY2tBY3Rpdml0eSk6IHZvaWQge1xuICAgIHRoaXMuYWN0aXZpdGllcy5wdXNoKGFjdGl2aXR5KTtcbiAgfVxuXG4gIHB1YmxpYyBwcmludCgpOiB2b2lkIHsgfVxuICBwdWJsaWMgc3RhcnQoKTogdm9pZCB7IH1cbiAgcHVibGljIHN0b3AoKTogdm9pZCB7IH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckNvbmRpdGlvbihjYjogKCkgPT4gYm9vbGVhbik6IFByb21pc2U8dm9pZD4ge1xuICB3aGlsZSAoIWNiKCkpIHtcbiAgICBhd2FpdCBzbGVlcCgxMCk7XG4gIH1cbn1cbiJdfQ==